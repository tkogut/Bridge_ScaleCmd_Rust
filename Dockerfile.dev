# Development Dockerfile for ScaleIT Bridge
FROM node:18-alpine AS frontend-dev

# Install development tools
RUN apk add --no-cache git curl

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY pnpm-lock.yaml ./

# Install dependencies
RUN npm install -g pnpm && pnpm install

# Copy source code
COPY . .

# Expose development port
EXPOSE 5173

# Start development server
CMD ["pnpm", "run", "dev", "--host", "0.0.0.0"]

# Backend development stage
FROM rust:1.75-alpine AS backend-dev

# Install development dependencies
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    curl \
    git

# Install cargo-watch for hot reloading
RUN cargo install cargo-watch

# Set working directory
WORKDIR /app

# Copy Cargo files
COPY src-rust/Cargo.toml src-rust/Cargo.lock ./src-rust/

# Create dummy source to cache dependencies
RUN mkdir -p src-rust/src && echo "fn main() {}" > src-rust/src/main.rs
RUN cd src-rust && cargo build
RUN rm -rf src-rust/src

# Copy actual source code
COPY src-rust/src ./src-rust/src

# Copy configuration
COPY config ./config

# Create logs directory
RUN mkdir -p logs

# Expose backend port
EXPOSE 8080

# Environment variables for development
ENV RUST_LOG=debug
ENV CONFIG_PATH=config/devices.json

# Start development server with hot reload
CMD ["sh", "-c", "cd src-rust && cargo watch -x run"]
